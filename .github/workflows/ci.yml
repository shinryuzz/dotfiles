name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # #########################################################
  # Lint
  # #########################################################
  lint:
    name: Shellcheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run shellcheck
        run: shellcheck setup.sh scripts/install-deps.sh

  # #########################################################
  # Test on Ubuntu
  # #########################################################
  test-ubuntu:
    name: Test (Ubuntu)
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Setup test environment
        run: |
          mkdir -p ~/.config
          mkdir -p ~/.local/share

      - name: Run setup.sh
        run: ./setup.sh

      - name: Verify symlinks created
        run: |
          test -L ~/.config/zsh
          test -L ~/.config/alacritty
          test -L ~/.config/nvim
          test -L ~/.config/tmux
          test -L ~/.hammerspoon

      - name: Run setup.sh again (idempotency check)
        run: ./setup.sh

      - name: Test force flag
        run: ./setup.sh --force

  # #########################################################
  # Test on macOS
  # #########################################################
  test-macos:
    name: Test (macOS)
    runs-on: macos-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Setup test environment
        run: |
          mkdir -p ~/.config
          mkdir -p ~/.local/share

      - name: Run setup.sh
        run: ./setup.sh

      - name: Verify symlinks created
        run: |
          test -L ~/.config/zsh
          test -L ~/.config/alacritty
          test -L ~/.config/nvim
          test -L ~/.config/tmux
          test -L ~/.hammerspoon

      - name: Verify symlink targets
        run: |
          readlink ~/.config/zsh | grep -q "zsh$"
          readlink ~/.config/tmux | grep -q "tmux$"

      - name: Test help flag
        run: ./setup.sh --help
